<?php
namespace Jangal;

class DilamiCalendarBase
{
    const LEAP_YEARS = array(
        199,
        203,
        207,
        211,
        215,
        220,
        224,
        228,
        232,
        236,
        240,
        244,
        248,
        253,
        257,
        261,
        265,
        269,
        273,
        277,
        281,
        286,
        290,
        294,
        298,
        302,
        306,
        310,
        315,
        319,
        323,
        327,
        331,
        335,
        339,
        343,
        348,
        352,
        356,
        360,
        364,
        368,
        372,
        376,
        381,
        385,
        389,
        393,
        397,
        401,
        405,
        409,
        414,
        418,
        422,
        426,
        430,
        434,
        438,
        443,
        447,
        451,
        455,
        459,
        463,
        467,
        471,
        476,
        480,
        484,
        488,
        492,
        496,
        500,
        504,
        509,
        513,
        517,
        521,
        525,
        529,
        533,
        537,
        542,
        546,
        550,
        554,
        558,
        562,
        566,
        571,
        575,
        579,
        583,
        587,
        591,
        595,
        599,
        604,
        608,
        612,
        616,
        620,
        624,
        628,
        632,
        637,
        641,
        645,
        649,
        653,
        657,
        661,
        665,
        669,
        674,
        678,
        682,
        686,
        690,
        694,
        698,
        703,
        707,
        711,
        715,
        719,
        723,
        727,
        731,
        736,
        740,
        744,
        748,
        752,
        756,
        760,
        764,
        769,
        773,
        777,
        781,
        785,
        789,
        793,
        797,
        802,
        806,
        810,
        814,
        818,
        822,
        826,
        831,
        835,
        839,
        843,
        847,
        851,
        855,
        859,
        864,
        868,
        872,
        876,
        880,
        884,
        888,
        892,
        897,
        901,
        905,
        909,
        913,
        917,
        921,
        925,
        930,
        934,
        938,
        942,
        946,
        950,
        954,
        959,
        963,
        967,
        971,
        975,
        979,
        983,
        987,
        992,
        996,
        1000,
        1004,
        1008,
        1012,
        1016,
        1020,
        1025,
        1029,
        1033,
        1037,
        1041,
        1045,
        1049,
        1053,
        1058,
        1062,
        1066,
        1070,
        1074,
        1078,
        1082,
        1087,
        1091,
        1095,
        1099,
        1103,
        1107,
        1111,
        1115,
        1120,
        1124,
        1128,
        1132,
        1136,
        1140,
        1144,
        1148,
        1153,
        1157,
        1161,
        1165,
        1169,
        1173,
        1177,
        1181,
        1186,
        1190,
        1194,
        1198,
        1202,
        1206,
        1210,
        1215,
        1219,
        1223,
        1227,
        1231,
        1235,
        1239,
        1243,
        1248,
        1252,
        1256,
        1260,
        1264,
        1268,
        1272,
        1276,
        1281,
        1285,
        1289,
        1293,
        1297,
        1301,
        1305,
        1309,
        1314,
        1318,
        1322,
        1326,
        1330,
        1334,
        1338,
        1343,
        1347,
        1351,
        1355,
        1359,
        1363,
        1367,
        1371,
        1376,
        1380,
        1384,
        1388,
        1392,
        1396,
        1400,
        1404,
        1409,
        1413,
        1417,
        1421,
        1425,
        1429,
        1433,
        1437,
        1442,
        1446,
        1450,
        1454,
        1458,
        1462,
        1466,
        1471,
        1475,
        1479,
        1483,
        1487,
        1491,
        1495,
        1499,
        1504,
        1508,
        1512,
        1516,
        1520,
        1524,
        1528,
        1532,
        1537,
        1541,
        1545,
        1549,
        1553,
        1557,
        1561,
        1565,
        1570,
        1574,
        1578,
        1582,
        1586,
        1590,
        1594,
        1599,
        1603,
        1607,
        1611,
        1615,
        1619,
        1623,
        1627,
        1632,
        1636,
        1640,
        1644,
        1648,
        1652,
        1656,
        1660,
        1665,
        1669,
        1673,
        1677,
        1681,
        1685,
        1689,
        1693,
        1698,
        1702,
        1706,
        1710,
        1714,
        1718,
        1722,
        1727,
        1731,
        1735,
        1739,
        1743,
        1747,
        1751,
        1755,
        1760,
        1764,
        1768,
        1772,
        1776,
        1780,
        1784,
        1788,
        1793,
        1797,
        1801,
        1805,
        1809,
        1813,
        1817,
        1821,
        1826,
        1830,
        1834,
        1838,
        1842,
        1846,
        1850,
        1855,
        1859,
        1863,
        1867,
        1871,
        1875,
        1879,
        1883,
        1888,
        1892,
        1896,
        1900,
        1904,
        1908,
        1912,
        1916,
        1921,
        1925,
        1929,
        1933,
        1937,
        1941,
        1945,
        1949,
        1954,
        1958,
        1962,
        1966,
        1970,
        1974,
        1978,
        1983,
        1987,
        1991,
        1995,
        1999,
        2003,
        2007,
        2011,
        2016,
        2020,
        2024,
        2028,
        2032,
        2036,
        2040,
        2044,
        2049,
        2053,
        2057,
        2061,
        2065,
        2069,
        2073,
        2077,
        2082,
        2086,
        2090,
        2094,
        2098,
        2102,
        2106,
        2111,
        2115,
        2119,
        2123,
        2127,
        2131,
        2135,
        2139,
        2144,
        2148,
        2152,
        2156,
        2160,
        2164,
        2168,
        2172,
        2177,
        2181,
        2185,
        2189,
        2193,
        2197,
        2201,
        2205,
        2210,
        2214,
        2218,
        2222,
        2226,
        2230,
        2234,
        2239,
        2243,
        2247,
        2251,
        2255,
        2259,
        2263,
        2267,
        2272,
        2276,
        2280,
        2284,
        2288,
        2292,
        2296,
        2300,
        2305,
        2309,
        2313,
        2317,
        2321,
        2325,
        2329,
        2333,
        2338,
        2342,
        2346,
        2350,
        2354,
        2358,
        2362,
        2367,
        2371,
        2375,
        2379,
        2383,
        2387,
        2391,
        2395,
        2400,
        2404,
        2408,
        2412,
        2416,
        2420,
        2424,
        2428,
        2433,
        2437,
        2441,
        2445,
        2449,
        2453,
        2457,
        2461,
        2466,
        2470,
        2474,
        2478,
        2482,
        2486,
        2490,
        2495,
        2499,
        2503,
        2507,
        2511,
        2515,
        2519,
        2523,
        2528,
        2532,
        2536,
        2540,
        2544,
        2548,
        2552,
        2556,
        2561,
        2565,
        2569,
        2573,
        2577,
        2581,
        2585,
        2589,
        2594,
        2598,
        2602,
        2606,
        2610,
        2614,
        2618,
        2623,
        2627,
        2631,
        2635,
        2639,
        2643,
        2647,
        2651,
        2656,
        2660,
        2664,
        2668,
        2672,
        2676,
        2680,
        2684,
        2689,
        2693,
        2697,
        2701,
        2705,
        2709,
        2713,
        2717,
        2722,
        2726,
        2730,
        2734,
        2738,
        2742,
        2746,
        2751,
        2755,
        2759,
        2763,
        2767,
        2771,
        2775,
        2779,
        2784,
        2788,
        2792,
        2796,
        2800,
        2804,
        2808,
        2812,
        2817,
        2821,
        2825,
        2829,
        2833,
        2837,
        2841,
        2845,
        2850,
        2854,
        2858,
        2862,
        2866,
        2870,
        2874,
        2879,
        2883,
        2887,
        2891,
        2895,
        2899,
        2903,
        2907,
        2912,
        2916,
        2920,
        2924,
        2928,
        2932,
        2936,
        2940,
        2945,
        2949,
        2953,
        2957,
        2961,
        2965,
        2969,
        2973,
        2978,
        2982,
        2986,
        2990,
        2994,
        2998,
        3002,
        3007,
        3011,
        3015,
        3019,
        3023,
        3027,
        3031,
        3035,
        3040,
        3044,
        3048,
        3052,
        3056,
        3060,
        3064,
        3068,
        3073,
        3077,
        3081,
        3085,
        3089,
        3093,
        3097,
        3101,
        3106,
        3110,
        3114,
        3118,
        3122,
        3126,
        3130,
        3135,
        3139,
        3143,
        3147,
        3151,
        3155,
        3159,
        3163,
        3168,
        3172,
        3176,
        3180,
        3184,
        3188,
        3192,
        3196,
        3201,
        3205,
        3209,
        3213,
        3217,
        3221,
        3225,
        3229,
        3234,
        3238,
        3242,
        3246,
        3250,
        3254,
        3258,
        3263,
        3267,
        3271,
        3275,
        3279,
        3283,
        3287,
        3291,
        3296,
        3300,
        3304,
        3308,
        3312,
        3316,
        3320,
        3324,
        3329,
        3333,
        3337,
        3341,
        3345,
        3349,
        3353,
        3357,
        3362,
        3366,
        3370,
    );
    const MONTH_NAMES = array(
        "پنجیک", "نؤرۊز ما", "کۊرچ ٚ ما", "أرئه ما",
        "تیر ما", "مۊردال ما", "شریرما",
        "أمیر ما", "آول ما", "سیا ما",
        "دیا ما", "ورفن ٚ ما", "اسفندار ما",
    );
    const WEEKDAY_NAMES = array(
        "یکشمبه", "دۊشمبه", "سۊشمبه", "چارشمبه", "پئنشمبه", "جۊمه", "شمبه",
    );

    public static function is_leap_year ($jy) {
        return in_array($jy, self::LEAP_YEARS);
    }

    public static function jalaliToDilami($jy, $jm, $jd)
    {
        if ($jm < 5 || ($jm == 5 && $jd < 17)) {
            $dy = $jy + 194;
        } else {
            $dy = $jy + 195;
        }

        switch ($jm) {
            case 5:
                $dm = $jd > 16 ? 1 : 12;
                $dd = $jd > 16 ? $jd - 16 : $jd + 14;
                break;
            case 6:
                $dm = $jd > 15 ? 2 : 1;
                $dd = $jd > 15 ? $jd - 15 : $jd + 15;
                break;
            case 7:
                $dm = $jd > 14 ? 3 : 2;
                $dd = $jd > 14 ? $jd - 14 : $jd + 16;
                break;
            case 8:
                $dm = $jd > 14 ? 4 : 3;
                $dd = $jd > 14 ? $jd - 14 : $jd + 16;
                break;
            case 9:
                $dm = $jd > 14 ? 5 : 4;
                $dd = $jd > 14 ? $jd - 14 : $jd + 16;
                break;
            case 10:
                $dm = $jd > 14 ? 6 : 5;
                $dd = $jd > 14 ? $jd - 14 : $jd + 16;
                break;
            case 11:
                $dm = $jd > 14 ? 7 : 6;
                $dd = $jd > 14 ? $jd - 14 : $jd + 16;
                break;
            case 12:
                $dm = $jd > 14 ? 8 : 7;
                $dd = $jd > 14 ? $jd - 14 : $jd + 16;
                break;
            case 1:
                $is_leap = self::is_leap_year($dy);
                if ($is_leap && $jd == 15) {
                    $dm = 0;
                    $dd = 0;
                } elseif ($is_leap && $jd < 15) {
                    $dm = 8;
                    $dd = $jd + 16;
                } elseif (!$is_leap && $jd < 16) {
                    $dm = 8;
                    $dd = $jd + 15;
                } elseif ($jd > 15 && $jd < 21) {
                    $dd = $jd - 15;
                    $dm = 0;
                } elseif ($jd > 20) {
                    $dm = 9;
                    $dd = $jd - (20);
                }
                break;
            case 2:
                $dm = $jd > 19 ? 10 : 9;
                $dd = $jd > 19 ? $jd - 19 : $jd + 11;
                break;
            case 3:
                $dm = $jd > 18 ? 11 : 10;
                $dd = $jd > 18 ? $jd - 18 : $jd + 12;
                break;
            case 4:
                $dm = $jd > 17 ? 12 : 11;
                $dd = $jd > 17 ? $jd - 17 : $jd + 13;
                break;
        }
        return array($dy, $dm, $dd);
    }

    function dilamiToJalali($dy, $dm, $dd)
    {
        if ($dm != 0 && ($dm < 8 || ($dm == 8 && $dd <= 15))) {
            $jy = $dy - 195;
        } else {
            $jy = $dy - 194;
        }

        if ($dm == 0 && $dd == 0) {
            return array($jy, 1, 15);
        }

        if ($dm == 0) {
            return array($jy, 1, $dd + 15);
        }

        switch ($dm) {
            case 1:
                $jm = $dd <= 15 ? 5 : 6;
                $jd = $dd <= 15 ? $dd + 16 : $dd - 15;
                break;
            case 2:
                $jm = $dd <= 16 ? 6 : 7;
                $jd = $dd <= 16 ? $dd + 15 : $dd - 16;
                break;
            case 3:
                $jm = $dd <= 16 ? 7 : 8;
                $jd = $dd <= 16 ? $dd + 14 : $dd - 16;
                break;
            case 4:
                $jm = $dd <= 16 ? 8 : 9;
                $jd = $dd <= 16 ? $dd + 14 : $dd - 16;
                break;
            case 5:
                $jm = $dd <= 16 ? 9 : 10;
                $jd = $dd <= 16 ? $dd + 14 : $dd - 16;
                break;
            case 6:
                $jm = $dd <= 16 ? 10 : 11;
                $jd = $dd <= 16 ? $dd + 14 : $dd - 16;
                break;
            case 7:
                $jm = $dd <= 16 ? 11 : 12;
                $jd = $dd <= 16 ? $dd + 14 : $dd - 16;
                break;
            case 8:
                $k = self::is_leap_year($dy) ? 1 : 0;
                $jm = $dd <= (15 + $k) ? 12 : 1;
                $jd = ($dd <= (15 + $k)) ? ($dd + 14) : ($dd - 15 - $k);
                if ($k == 1 && $dd == 16) {
                    $jy = $jy - 1;
                }
                break;
            case 9:
                $jm = $dd <= 11 ? 1 : 2;
                $jd = $dd <= 11 ? $dd + 20 : $dd - 11;
                break;
            case 10:
                $jm = $dd <= 12 ? 2 : 3;
                $jd = $dd <= 12 ? $dd + 19 : $dd - 12;
                break;
            case 11:
                $jm = $dd <= 13 ? 3 : 4;
                $jd = $dd <= 13 ? $dd + 18 : $dd - 13;
                break;
            case 12:
                $jm = $dd <= 14 ? 4 : 5;
                $jd = $dd <= 14 ? $dd + 17 : $dd - 14;
                break;
        }
        return array($jy, $jm, $jd);
    }
}
